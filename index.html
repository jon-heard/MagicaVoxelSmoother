<html>
	<head>
		<title>MagicaVoxel Smoother</title>
		<link rel='icon' type='image/png' href='favicon.png'/>
		<script src='libs/fileUpdatedListeners.js'></script>
		<script src='libs/voxParser.js'></script>
		<script src='libs/smootherLogic.js'></script>
		<script src='libs/glMatrix.js'></script>
		<script src='libs/webgl.js'></script>
		<script src='libs/cam_orbit.js'></script>
		<script src='libs/meshes.js'></script>
		<script src='libs/smootherRenderLogic.js'></script>
		<script src='libs/exportObj.js'></script>
		<style>
			.fatalErr
			{
				background-color: red;
				text-align: center;
				font-size: 150%;
				font-weight: bold;
				color: yellow;
			}
			body
			{
				display: flex;
				flex-flow: column;
			}
			#head
			{
				flex: 0 1 auto;
				margin-bottom: 0.5em;
			}
			#view
			{
				flex: 1 1 auto;
			}
			#hiddenVoxFileSelector, #hiddenMvsFileSelector, #manualExport
			{
				display: none;
			}
			#voxfileName, #mvsFileName, #objFileName
			{
				padding: 0em 1em;
				border: 1px solid black;
				margin-right: .25em;
			}
			#showSmooth
			{
				margin-left: 1em;
			}
		</style>
	</head>
	<body onload='main()'>
		<div id='head'>
			<button id='voxFileSelector'>Open VOX model</button>
			<span id='voxFileName'></span>
			<button id='mvsFileSelector'>Open smoothing config</button>
			<span id='mvsFileName'></span>
			<span id='objFileName'></span>
			<button id='manualExport'>Export OBJ model</button>
			<input type='file' id='hiddenVoxFileSelector' accept='.vox'/>
			<input type='file' id='hiddenMvsFileSelector' accept='.mvs'/>
			<input type='checkbox' id='showSmooth' checked>Show smoothing</input>
		</div>
		<canvas id='view'></canvas>
	</body>
</html>

<script>
	let voxData;
	let usingNativeFileIO = true;
	let voxFile, mvsFile, objFile;

	function main()
	{
		// 3d stuff
		if (!initRendering())
		{
			return;
		}

		// file handling
		if (typeof window.chooseFileSystemEntries === "undefined")
		{
			usingNativeFileIO = false;
			alert("This web app works best with chrome's 'Native File System API', through which it can auto-export the OBJ file as you work.\nYou can enable this experimental feature at 'chrome://flags/'.");
			document.getElementById("objFileName").style.display = "none";
		}
		else
		{
			document.getElementById("mvsFileSelector").style.display = "none";
		}

		document.getElementById("voxFileSelector").addEventListener("click", onVoxFileSelectorClicked);
		document.getElementById("mvsFileSelector").addEventListener("click", onMvsFileSelectorClicked);
		fileUpdatedListeners.add(document.getElementById("hiddenVoxFileSelector"), onVoxFileUpdated);
		document.getElementById("hiddenVoxFileSelector").addEventListener("change", onFileSelect);
		fileUpdatedListeners.add(document.getElementById("hiddenMvsFileSelector"), onMvsFileUpdated);
		document.getElementById("manualExport").addEventListener("click", onManualExport);

		// Start frame looping
		requestAnimationFrame(frameLogic);
	}

	// Destroys all content except for error message
	function onFatalError(error)
	{
		document.getElementsByTagName("body")[0].innerHTML = "<div class='fatalErr'>" + error + "</div";
		return false;
	}

	// Each time a file is selected
	function onFileSelect(evt)
	{
		resetCamOrbit();
		alert("Now choose an (optional) 'smoothing config' file to customize the smoothing.");
	}

	// Called each time source model file changes
	// Loads and prepares voxel data
	function onVoxFileUpdated(file)
	{
		console.log("Vox modified externally");
		const reader = new FileReader();
		reader.onload = function()
		{
			document.getElementById('voxFileName').innerHTML = file.name;
			voxData = parseVox(reader.result);
			smoother_processVoxData(voxData);
			document.getElementById("manualExport").style.display = "unset";
		};
		reader.readAsArrayBuffer(file);
	}

	// Called each time VMSmooth config file changes
	function onMvsFileUpdated(file)
	{
		console.log("Mvs modified externally");
		const reader = new FileReader();
		reader.onload = function()
		{
			document.getElementById('mvsFileName').innerHTML = file.name;
			smootherConfig = JSON.parse(bin2Str(reader.result, 0, reader.result.byteLength));
			processConfigData(voxData);
		};
		reader.readAsArrayBuffer(file);
	}


	function clickElement(element)
	{
		if(element && document.createEvent)
		{
			var evt = document.createEvent("MouseEvents");
			evt.initEvent("click", true, false);
			element.dispatchEvent(evt);
		}
	}
	async function onVoxFileSelectorClicked()
	{
		if (usingNativeFileIO)
		{
			try
			{
				newVoxFile = await chooseFileSystemEntries({ type: "openFile", excludeAcceptAllOption: true, accepts: [{ description: "MagicaVoxel model", extensions: ["vox"]}] });
				try
				{
					newMvsFile = await chooseFileSystemEntries({ type: "openFile", excludeAcceptAllOption: true, accepts: [{ description: "MagicaVoxel smooth customization", extensions: ["mvSmooth"]}] });
				}
				catch (exception)
				{
					newMvsFile = await chooseFileSystemEntries({ type: "saveFile", excludeAcceptAllOption: true, accepts: [{ description: "MagicaVoxel smooth customization", extensions: ["mvSmooth"]}] });
				}
				newObjHandle = await chooseFileSystemEntries({ type: "saveFile", excludeAcceptAllOption: true, accepts: [{ description: "Exported OBJ", extensions: ["obj"]}] });
				voxHandle = newVoxHandle;
				customHandle = newCustomHandle;
				objHandle = newObjHandle;
				document.getElementById("result").innerHTML = "vox = " + newVoxHandle.name + " :: customization = " + (customHandle?customHandle.name:"none") + " :: object export = " + objHandle.name;
			}
			catch (exception) {}
		}
		else
		{
			clickElement(document.getElementById("hiddenVoxFileSelector"));
		}
	}

	function onMvsFileSelectorClicked()
	{
		clickElement(document.getElementById("hiddenMvsFileSelector"));
	}

	function downloadNewFile(filename, content, isRawContent)
	{
		var e = document.createElement("a");
		e.setAttribute("download", filename);
		if (isRawContent)
		{
			e.setAttribute("href", content);
		}
		else
		{
			e.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(content));
		}
		e.style.display = 'none';
		document.body.appendChild(e);
		e.click();
		document.body.removeChild(e);
	}

	function onManualExport()
	{
		let modelName = document.getElementById("hiddenVoxFileSelector").files[0].name.replace(".vox", "");
		let objModel = exportObj(modelName, voxData);
		downloadNewFile(modelName + ".obj", objModel.obj);
		downloadNewFile(modelName + ".mtl", objModel.mtl);
		downloadNewFile(modelName + ".png", objModel.png, true);
	}
</script>
